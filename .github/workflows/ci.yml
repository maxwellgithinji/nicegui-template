name: Build Desktop Executables

on:
  push:
    branches: [main, master]
    tags: ["v*"]        # also run on version tags
  workflow_dispatch:

jobs:
  # ── Ubuntu build ─────────────────────────────────────────────────────────────
  build-ubuntu:
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps (GTK / WebKit / PyGObject)
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            gir1.2-webkit2-4.0 \
            libgirepository1.0-dev \
            gcc libcairo2-dev pkg-config \
            python3-gi \
            python3-gi-cairo \
            xvfb

      # Use the system Python that already has gi installed (python3-gi from apt)
      # and layer our pip packages on top via --system-site-packages
      - name: Set up Python (system-linked venv)
        run: |
          python3 -m venv --system-site-packages .venv
          echo "${{ github.workspace }}/.venv/bin" >> $GITHUB_PATH

      - name: Install Python deps
        run: |
          .venv/bin/pip install --upgrade pip
          .venv/bin/pip install -r requirements.txt

      - name: Verify gi is importable
        run: .venv/bin/python -c "import gi; print('gi OK:', gi.__version__)"

      - name: Build with PyInstaller
        run: |
          .venv/bin/pyinstaller "${{ github.workspace }}/build.spec" \
            --clean \
            --distpath "${{ github.workspace }}/dist" \
            --workpath "${{ github.workspace }}/build"

      - name: Smoke-test binary exists
        run: test -f "${{ github.workspace }}/dist/NiceGUIApp/NiceGUIApp"

      - name: Upload Ubuntu artifact
        uses: actions/upload-artifact@v4
        with:
          name: NiceGUIApp-ubuntu
          path: ${{ github.workspace }}/dist/NiceGUIApp/
          retention-days: 30

  # ── Windows build ─────────────────────────────────────────────────────────────
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        working-directory: ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build with PyInstaller
        run: |
          pyinstaller "${{ github.workspace }}\build.spec" `
            --clean `
            --distpath "${{ github.workspace }}\dist" `
            --workpath "${{ github.workspace }}\build"

      - name: Smoke-test binary exists
        run: Test-Path "${{ github.workspace }}\dist\NiceGUIApp\NiceGUIApp.exe"
        shell: pwsh

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: NiceGUIApp-windows
          path: ${{ github.workspace }}\dist\NiceGUIApp\
          retention-days: 30

  # ── Release on version tags ───────────────────────────────────────────────────
  release:
    needs: [build-ubuntu, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout (for CHANGELOG)
        uses: actions/checkout@v4

      - name: Download Ubuntu build
        uses: actions/download-artifact@v4
        with:
          name: NiceGUIApp-ubuntu
          path: release/ubuntu

      - name: Download Windows build
        uses: actions/download-artifact@v4
        with:
          name: NiceGUIApp-windows
          path: release/windows

      - name: Zip artifacts
        run: |
          cd release
          zip -r NiceGUIApp-ubuntu.zip ubuntu/
          zip -r NiceGUIApp-windows.zip windows/

      - name: Extract release notes from CHANGELOG.md
        id: changelog
        run: |
          # Pull out the block for this tag between its heading and the next
          TAG=${GITHUB_REF_NAME}
          NOTES=$(awk "/^## \[?${TAG}\]?/{found=1; next} found && /^## /{exit} found{print}" ${{ github.workspace }}/CHANGELOG.md)
          if [ -z "$NOTES" ]; then
            NOTES="No changelog entry found for ${TAG}."
          fi
          # Write to a file to preserve newlines
          echo "$NOTES" > /tmp/release_notes.md
          echo "notes_file=/tmp/release_notes.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/NiceGUIApp-ubuntu.zip
            release/NiceGUIApp-windows.zip
          body_path: ${{ steps.changelog.outputs.notes_file }}